---
title: "Subir datos de campo ago-dic 2022"
---

Los datos fueron capturados en una tabla con las siguientes columnas :

- codigo_campo = codigo temporal del periódico 
- id_ejemplar = codigo temporal del periodico (podría ser el codigo de foto)
- id_individuo = id de la BD    
- temp_especie	
- Localidad	
- Municipio	
- Estado	
- Pais	
- Latitud	
- Longitud	
- Altitud	
- Tipo_vegetacion	
- Colectores	
- Fecha_colecta	
- comentarios

## Tablas BD


```{r}

library(googlesheets4)
library(tidyverse)
library(RMariaDB)

# Preprar la conexión para llamar información o para subirla.
conn <- dbConnect(
      drv = RMariaDB::MariaDB(),
      username = "sofia",
      password = "MDB!2019#",
      host = "localhost",
      port = 3306,
      dbname = "ejemplares_BN"
    )

# Importar los datos de las salidas de campo del 2022
data = read_sheet("https://docs.google.com/spreadsheets/d/1IloUmr7sYNDFX1yjt5BgXKrP3ty4bCYTsPQnTyMYEUg/edit?usp=sharing", sheet = 1, col_type = "ccicccccddiccDc")

# Separar la información en las tablas de la BD
# Ejemplares

ejemplares = data %>%
        bind_cols(id_ejemplar = seq(1163,1162+198,1)) %>%
        select(id_ejemplar, id_individuo,codigo_colecta = codigo_campo) %>% 
        mutate(localizacion = NA, 
                fecha_ingreso_bd = as.Date("15-02-2023",format = "%d-%m-%Y"))

# Individuos

edo_mun <- dbSendQuery(conn, "SELECT em.id_estado, em.id_municipio, e.estado, m.municipio  FROM estados_municipios em 
                              left join estados e ON em.id_estado = e.id_estado 
                              left JOIN municipios m ON em.id_municipio = m.id_municipio ") %>% dbFetch(.)

tipo_veg = dbSendQuery(conn, "SELECT * FROM tipos_vegetacion") %>% dbFetch(.)

# Corrección de error
data[which(data$Municipio == "San Ildelfonso de Villa Alta"),"Municipio"] = "San Ildefonso Villa Alta"

individuos  = data %>%
        mutate(prec_horizontal = NA,
               prec_vertical = NA,
               observaciones = NA,
               id_especie = NA,
               id_pais = "MEX",
               tipo_veg = tolower(Tipo_vegetacion)) %>%
        left_join(.,unique(edo_mun[,c("id_estado","estado")]), by = c("Estado"="estado")) %>% 
        left_join(.,unique(edo_mun[,c("id_municipio","municipio","id_estado")]), by = c("Municipio"="municipio", "id_estado" = "id_estado")) %>%
        left_join(.,tipo_veg, by = "tipo_veg") %>%
        select(id_individuo,
               latitud = Latitud,
               longitud = Longitud,
               prec_horizontal,
               altitud = Altitud,
               prec_vertical,
               fecha = Fecha_colecta,
               desc_localidad = Localidad,
               observaciones,
               id_estado,
               id_pais,
               id_municipio,
               id_veg,
               id_especie,
               comentarios) %>% distinct() 

# Ejemplares-colectores

ejemplares_colectores = data %>% 
    bind_cols(id_ejemplar = seq(1163,1162+198,1)) %>% 
    separate(col = Colectores,into = c(paste0("col",seq(1,5,1))),sep = ",") %>% 
    select(id_ejemplar,starts_with("col")) %>%
    pivot_longer(cols = starts_with("col"), names_to = "n_col", values_to = "id_colector") %>%
    filter(!is.na(id_colector)) %>%
    mutate(id_colector = str_remove(id_colector, " ")) %>%
    select(-n_col) 

# Faltan la tabla de fotos!
# Falta poner en que caja está cada ejemplar!

```

### Subir información a la BD


```{r}

# Subir info individuos 

#dbWriteTable(conn = conn,name = "individuos", append = T,value = individuos, header = T,row.names=F)

#ejemplares

#dbWriteTable(conn = conn,name = "ejemplares", append = T,value = ejemplares, header = T,row.names=F)

# ejemplares_colectores

#dbWriteTable(conn = conn,name = "ejemplares_colectores", append = T,value = ejemplares_colectores, header = T,row.names=F)

```
